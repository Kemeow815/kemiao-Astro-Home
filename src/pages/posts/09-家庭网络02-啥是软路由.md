---
layout: "../../layouts/BlogPost.astro"
title: "家庭网络搭建02-什么是软路由"
description: "Hello 朋友们，最近折腾了一些家庭网络相关的内容，中间因为 GFW 踩了不少坑，浪费了至少得有上十个小时的时间"
pubDate: "2022-12-11"
heroImage: "/assets/imgs/ee1b8ffd6dc8af320342ebb0c83058895c571c24712f9006fdcfa600a2c0466b.png"
---

Hello 朋友们大家好，又是一周不见，本周为大家整理了我折腾软路由的相关资料和个人的思考

本期**软路由方案**，是上周`科学上网`文章中**方案二**的扩展，如果还没有看过的朋友可以点[链接](https://blog.peterchen97.cn/posts/08-%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C-%E5%95%A5%E6%98%AFGFW)查看一下

# 什么是软路由

## 网络级别的「事件委托」处理人

虽然我本科是计算机专业，但是对于网络以及路由器的理解一直是懂点皮毛，只是隐隐约约感觉，如果我们如果将一些复杂的软件操作，托管在我们终端（如手机、电脑和 iPad）上一层的路由器上，应该能够省事不少

![picture 48](/assets/imgs/d96c0b69c0a28b53b18015d7a2ee5ef79e6c9bdeeabb96a3ae110b284ab7d3fc.png)  

就比如说网络拨号，在很久很久以前使用 `GPRS` 拨号上网的年代，所有的设备接上网卡以后，都必须自己通过软件拨号上网，这个步骤是非常繁琐的。假设我们现在的 PPPoe 拨号不是在路由器上配置，而是所有终端都配一遍，每次上网前手动连接，想想都是挺复杂的吧

![picture 49](/assets/imgs/331bc5edc2162fe5b47cafe1d6e146ba75d0f5a3228214cc287ed38c2a4f8a13.png)  

那么同理，既然现在的路由器（或者在上一级的光猫）已经承载了我们的网络拨号功能，那么能不能再进一步，帮我们把上期翻越 GFW 的工作也做了呢，那么当然是可以的了

但是为什么大家往往都不知道这个方法呢🤔，原因其实有几点：

- 首先从软件上看，科学上网是一个门槛很高的事情，就算集成在现有路由器上，一般用户也玩不来，更别说这是不可能的
- 其次从硬件上看，现在大家能买到的路由器，包括我家还算高端的小米 AX3600，**厂商设计角度出发来看，它本身的功能就是路由和交换，并没有支持运行我们软件复杂功能**（如加密解密）的完善的硬件条件，也没有那个必要

所以说就算你成功通过路由器固件刷写，完成了所需环境的搭建，实际上的运行效果可能也会差强人意，并且在此基础上去做扩展的可能性也是微乎其微，基本上比较难胜任一个家庭网络中枢的职责

那么这时候就是软路由派上用场的时候了！

## 软硬路由的区别

**到此为止，我们需要了解一个简单的概念，就是硬路由和软路由的区别：**

> `硬件路由器`：也就是我们在网上直接搜索路由器出来的各类路由器，是通过硬件直接实现网络的路由和交换任务的设备

![picture 52](/assets/imgs/0b87bf2d2fabee87f54764d1acd71b8097aa9bea13e52d670b1347550c22afd9.png)  

> `软件路由器`：大部分朋友可能都没有见过，就如本篇文章中封面的 MT2500 一样，是一个比较小巧袖珍的硬件设备，通过软件来实现路由器的主要职责，所以叫软路由

![picture 53](/assets/imgs/eee9ab8aaa84a342fd47428fcdf770b69a286f5cf83d238f84555eee92022596.png)  

**大家可能会有几个疑问：**

- 一个是这么小的硬件能解决我们的路由功能需求吗？
- 一个是能不能用我们自己的电脑来代替软路由呢？

**别急一个一个来，首先，不难发现，我们软路由没有传统硬路由的八爪鱼天线，那么他能解决我们的路由功能吗**

答案是可以的，因为软硬路由不是相互替代的关系，而是共同合作居多。正常来说，软硬路由的合作关系，可以参考下面的这张网络拓扑图：

![picture 41](/assets/imgs/e0d8cd04916aa48638b4df08d6cc15df96e08ce0fb9396ec70fc04c8e1cceb84.png)  

这里面的主路由一般是硬件路由器，旁路由是软件路由器，和我目前的网络结构是一样的，这里旁路由也只是一种配置软路由的叫法，大家可以这么理解就好

这里比较合适的方案是，使用硬路由为整个家庭提供无线网络，软路由仅仅提供网络数据解析功能，所以软路由本身也就没有必要再给自己加上复杂的天线了，反而更加便携和小巧

**第二个问题也就是第一篇文章中 AK 分享中提到的，网关模式，感兴趣的朋友再次返回观看即可，这里就不做展开啦**

# 如何搭建软路由

## 选择软路由

通过上面的简单介绍，大家脑海中应该有了一副家庭网络的结构了，接下来只需要买上一个软路由，把它接进我们现有的网络中，就大功告成了

这里我是在闲鱼上淘了一个 J3160 主板的一个小主机，用来作为软路由使用，这里有几个点：

- 尽量选择质量好的
- 尽量选择功耗小的

因为我们软路由基本上是 24h 工作的，对于质量和功能要求较高，当然国家电网合作伙伴可以不做考虑hhh

基本上一个软路由的价格在 200 - 500 不等，大家可以根据自己的网络需求，酌情购买

这里有一个不错的参考资料，贴一下

> <https://www.youtube.com/watch?v=Nc32FPwYwjk&ab_channel=jackstone>

![picture 42](/assets/imgs/51824bbc30c5e0d74f70797d68ad3d17d505f8ded015ce89f8fee1183b9fdb6f.png)  

我买的这个体积也不算小了，有点像一个 ITX 的主机

![picture 54](/assets/imgs/5fecf9ff077153307bcd1369152826aff6f21e961a24edbf59369b63b10623b1.png)  

## 系统选择

这里比较经典的就是 openwrt 了，但是我了解到一个基于 openwrt 开发的国产路由系统，整体的可用性和安装成本也低了不少，名字叫 iStoreOS，大家可以在官网中下载，通过 U 盘安装的方式，将软路由的操作系统安装上即可，这里也有一个手把手的贴心教程

> <https://www.youtube.com/watch?v=PRrXpa_4xdA&ab_channel=%E6%82%9F%E7%A9%BA%E7%9A%84%E6%97%A5%E5%B8%B8>

![picture 43](/assets/imgs/d5ebd68c40724ba2c8d3bd6c1fb3692afbe45eb096f329859b796162eab0b523.png)

到这里你就应该已经完成了软路由系统的搭建，进入到 iStoreOS 的界面中了，接下来，我们需要将它接入我们的家庭网络中

## 网络接入

这里依然有一个贴心教程，大家可以通过这个教程，完成网络接入的工作

> <https://www.youtube.com/watch?v=w7rwNF2Q3lM&t=6s&ab_channel=%E6%B4%8B%E8%91%B1>

![picture 44](/assets/imgs/1739ee5c58cbc8a79b3f0e4219f05c11b32341197e4103a5a955973a75b5183c.png)  

**总的来说主要步骤如下：**

- 软路由子网入口修改，解决在主路由网络中无法访问软路由的问题
- 配置软路由中的相关参数
  - DNS
  - DHCP
- 接入方案选择
  - 侵入性
  - 非侵入性

这里有关这两种接入方案，我展开讲讲

**首先侵入与非侵入的区别在于，是否使用软路由作为家庭网络的 DHCP 配置方**，对应的优缺点也各有不同，这里我用我目前的非侵入式方案，做一下优缺点的说明：

- **优点：**
  - 在软路由的软件功能异常（如软件崩溃、机场的 Instance 挂了等情况）时，不会影响家庭网络中相关设备对于国内正常网络的访问，不会出现经典的 `One Boom，All Boom ！` 的情况
  - 对于不想经过软路由的一些设备来说，软路由的加入，对于他们完全无感
- **缺点：**
  - 对于每一台需要经过软路由的终端设备，需要手动的配置对应的 DNS 和 Router，会比较繁琐

这里从我的实践经验来看，无疑选择非侵入式的方案时最稳妥的，毕竟软件路由器的稳定性还是比不上硬件路由器的，可能会出现各种各样的问题

如果网络突然中断，将终端的 Router 和 DNS 改回到主路由上，那就是无事发生 hhh

# 如何通过软路由科学上网

到这里你应该已经能够通过终端，访问家庭网络中的软路由系统了，接下来就是如果通过相关插件，实现科学上网了

## 安装 OpenClash

这里又有一个手把手教程送给大家

> <https://www.youtube.com/watch?v=8adTDuzxUo8&t=28s&ab_channel=%E5%90%91%E5%8C%97>

![picture 45](/assets/imgs/8b2e45e0bf4b759656314c8278e0730c1d03d08fd6261bb5007e5be9b0afd8ff.png)  

**主要步骤如下：**

- 使用 Are U Ok 的 openwrt 第三方插件库，下载安装 OpenClash
  - 关于这里为什么用 OpenClash 而不用其他几种，这里我说一下，之前用过 SSR+ 和 Passwall，发现在我家的网络环境下都无法正常访问，可能是软件或者协议有一些问题，所以还是直接用 OpenClash 比较方便
- 在 iStore 中手动安装 OpenClash
- 完成机场参数的配置
- 启动 OpenClash
  - 然后 OpenClash 的内核是需要手动安装的，这个地方卡了我一段时间，具体方法，就是通过 Github 下载完内核以后，通过 iStoreOS 的文件上传，传到指定目录，之后重新运行 OpenClash 即可

正常来说，这个时候，你的软路由已经可以访问广阔的互联网了，那么如何将它普惠给所有家庭网络设备呢

## 配置终端网络指向

这里以 iPhone 为例，将 WIFI 的配置打开后，我们可以看到配置 IP 和 DNS 的地方

![picture 46](/assets/imgs/4046a5796f9c545e6525e3f3a7f9c1d0cfe25c79d56f40748b228e4d13c41225.png)  

这里手动将我们的 Router 和 DNS 指向我们的软路由，让终端的网络访问路径经过软路由，这里我配置的软路由地址是：`192.168.31.2`

接下来，就是见证奇迹的时刻～

## 迎接新世界

![picture 47](/assets/imgs/e711314ae3e1dd56df6e48e1bcdaa4eca9f9186c9a39c3340a98735bb3c14323.png)  

当当！你已经无需手机软件，即可正常访问互联网啦

# 总结

第二篇的内容相对于第一篇的理论来说，更加偏向于实践了，如果手上有设备的朋友们，不妨动手尝试一下，不再需要配置 Terminal 代理和系统代理来正常访问互联网的感觉可太棒了hhh

软路由除了可以用相应的软路由硬件以外，使用树莓派也是 ok 的，但是考虑到性能，还是单独买一个设备比较稳妥，毕竟后面我们还是需要基于这个网络中枢做更多的事情的，包括：HomeAssistant 智能家庭中枢、网络服务部署......

感兴趣的朋友不妨订阅一下，后面会更新关于家庭网络的一些实际应用场景，咱们下次见
